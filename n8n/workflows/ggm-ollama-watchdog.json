{
  "name": "GGM Ollama Watchdog",
  "nodes": [
    {
      "parameters": {},
      "id": "start-node",
      "name": "Start",
      "type": "n8n-nodes-base.start",
      "typeVersion": 1,
      "position": [100, 300]
    },
    {
      "parameters": {
        "rule": {
          "interval": [{ "field": "minutes", "minutesInterval": 30 }]
        }
      },
      "id": "cron-watchdog",
      "name": "‚è∞ Every 30 mins",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [300, 300]
    },
    {
      "parameters": {
        "url": "={{ $env.OLLAMA_URL || 'http://host.docker.internal:11434' }}/api/tags",
        "options": {
          "timeout": 15000,
          "allowUnauthorizedCerts": false
        }
      },
      "id": "check-ollama",
      "name": "üîç Check Ollama",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [550, 300],
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [],
          "number": [
            {
              "value1": "={{ $json.statusCode || 200 }}",
              "operation": "equal",
              "value2": 200
            }
          ]
        }
      },
      "id": "is-running",
      "name": "Running?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [800, 300]
    },
    {
      "parameters": {
        "command": "ollama serve",
        "timeout": 10
      },
      "id": "start-ollama",
      "name": "üöÄ Start Ollama",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [1050, 400],
      "continueOnFail": true,
      "notes": "Starts Ollama serve in background. Short timeout so it doesn't block."
    },
    {
      "parameters": {
        "amount": 30,
        "unit": "seconds"
      },
      "id": "wait-startup",
      "name": "‚è≥ Wait 30s",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [1300, 400]
    },
    {
      "parameters": {
        "url": "={{ $env.OLLAMA_URL || 'http://host.docker.internal:11434' }}/api/tags",
        "options": { "timeout": 15000 }
      },
      "id": "recheck-ollama",
      "name": "üîç Re-check Ollama",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1550, 400],
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.statusCode || 200 }}",
              "operation": "equal",
              "value2": 200
            }
          ]
        }
      },
      "id": "is-running-now",
      "name": "Running now?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1800, 400]
    },
    {
      "parameters": {
        "url": "https://api.telegram.org/bot{{ $env.TG_BOT_TOKEN }}/sendMessage",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            { "name": "chat_id", "value": "={{ $env.TG_CHAT_ID }}" },
            { "name": "text", "value": "‚úÖ Ollama was down ‚Äî auto-restarted successfully" },
            { "name": "parse_mode", "value": "HTML" }
          ]
        }
      },
      "id": "tg-restarted",
      "name": "üì± Notify: Restarted",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2050, 350]
    },
    {
      "parameters": {
        "url": "https://api.telegram.org/bot{{ $env.TG_BOT_TOKEN }}/sendMessage",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            { "name": "chat_id", "value": "={{ $env.TG_CHAT_ID }}" },
            { "name": "text", "value": "‚ùå <b>ALERT:</b> Ollama is down and could not be auto-restarted. Please check manually." },
            { "name": "parse_mode", "value": "HTML" }
          ]
        }
      },
      "id": "tg-failed",
      "name": "üö® Alert: Still Down",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2050, 500]
    }
  ],
  "connections": {
    "‚è∞ Every 30 mins":    { "main": [[ { "node": "üîç Check Ollama",     "type": "main", "index": 0 } ]] },
    "üîç Check Ollama":     { "main": [[ { "node": "Running?",            "type": "main", "index": 0 } ]] },
    "Running?":             { "main": [[], [ { "node": "üöÄ Start Ollama", "type": "main", "index": 0 } ]] },
    "üöÄ Start Ollama":     { "main": [[ { "node": "‚è≥ Wait 30s",         "type": "main", "index": 0 } ]] },
    "‚è≥ Wait 30s":         { "main": [[ { "node": "üîç Re-check Ollama",  "type": "main", "index": 0 } ]] },
    "üîç Re-check Ollama":  { "main": [[ { "node": "Running now?",        "type": "main", "index": 0 } ]] },
    "Running now?":         { "main": [
      [ { "node": "üì± Notify: Restarted", "type": "main", "index": 0 } ],
      [ { "node": "üö® Alert: Still Down", "type": "main", "index": 0 } ]
    ]}
  },
  "settings": {
    "timezone": "Europe/London",
    "saveManualExecutions": true,
    "saveDataErrorExecution": "all"
  },
  "tags": [
    { "name": "GGM", "id": "ggm" },
    { "name": "Infrastructure", "id": "infra" }
  ],
  "meta": {
    "instanceId": "ggm-gardners"
  }
}
