<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://script.google.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' https: data:; connect-src 'self' https://script.google.com; object-src 'none'; base-uri 'self';">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta name="robots" content="noindex, nofollow">
    <title>Unsubscribe â€” Gardners Ground Maintenance</title>
    <link rel="icon" type="image/svg+xml" href="images/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .unsub-container {
            max-width: 500px;
            margin: 120px auto 60px;
            padding: 40px 30px;
            background: var(--card-bg, #fff);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
            text-align: center;
        }
        .unsub-icon { font-size: 3rem; margin-bottom: 16px; }
        .unsub-title { font-size: 1.5rem; font-weight: 700; color: #333; margin-bottom: 8px; }
        .unsub-desc { color: #666; font-size: 0.95rem; line-height: 1.6; margin-bottom: 24px; }
        .unsub-email { font-weight: 600; color: #2E7D32; }
        .unsub-btn {
            display: inline-block;
            background: #e74c3c;
            color: #fff;
            border: none;
            padding: 14px 32px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .unsub-btn:hover { background: #c0392b; transform: translateY(-1px); }
        .unsub-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .unsub-success {
            display: none;
            background: #f0fff0;
            border: 1px solid #2E7D32;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            color: #2E7D32;
        }
        .unsub-error {
            display: none;
            background: #fff0f0;
            border: 1px solid #e74c3c;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            color: #e74c3c;
        }
        .unsub-back {
            display: inline-block;
            margin-top: 20px;
            color: #2E7D32;
            text-decoration: none;
            font-weight: 500;
        }
        .unsub-back:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <!-- Minimal nav -->
    <header class="site-header" style="position:fixed;width:100%;top:0;z-index:100;background:rgba(255,255,255,0.97);box-shadow:0 2px 8px rgba(0,0,0,0.06);">
        <div class="container" style="display:flex;align-items:center;justify-content:space-between;padding:12px 20px;">
            <a href="/" style="display:flex;align-items:center;gap:10px;text-decoration:none;">
                <img src="images/logo.png" alt="GGM" width="40" height="40" style="border-radius:50%;">
                <span style="font-weight:700;color:#2E7D32;font-size:1.1rem;">Gardners GM</span>
            </a>
        </div>
    </header>

    <div class="unsub-container" id="unsubContainer">
        <div class="unsub-icon">ðŸ“§</div>
        <h1 class="unsub-title">Unsubscribe</h1>
        <p class="unsub-desc">
            You're about to unsubscribe <span class="unsub-email" id="emailDisplay"></span> from service emails from Gardners Ground Maintenance.
        </p>
        <p class="unsub-desc" style="font-size:0.85rem;color:#999;">
            You'll stop receiving job reminders, completion summaries, and seasonal offers. Transactional emails (invoices, booking confirmations) will still be sent.
        </p>
        <button class="unsub-btn" id="unsubBtn" onclick="handleUnsubscribe()">
            <i class="fas fa-envelope-open"></i>&nbsp; Unsubscribe
        </button>

        <div class="unsub-success" id="successMsg">
            <i class="fas fa-check-circle" style="font-size:1.5rem;margin-bottom:8px;display:block;"></i>
            <strong>You've been unsubscribed.</strong><br>
            You won't receive any more marketing or service emails from us.<br>
            Changed your mind? Just <a href="mailto:enquiries@gardnersgm.co.uk" style="color:#2E7D32;font-weight:600;">email us</a>.
        </div>

        <div class="unsub-error" id="errorMsg">
            <i class="fas fa-exclamation-circle" style="font-size:1.5rem;margin-bottom:8px;display:block;"></i>
            <strong>Something went wrong.</strong><br>
            Please try again or email <a href="mailto:enquiries@gardnersgm.co.uk" style="color:#e74c3c;font-weight:600;">enquiries@gardnersgm.co.uk</a> to unsubscribe manually.
        </div>

        <a href="/" class="unsub-back"><i class="fas fa-arrow-left"></i> Back to gardnersgm.co.uk</a>
    </div>

    <script>
        var GAS_URL = 'https://script.google.com/macros/s/AKfycbxaT1YOoDZtVHP9CztiUutYFqMiOyygDJon5BxCij14CWl91WgdmrYqpbG4KVAlFh5IiQ/exec';

        // Get email from URL params
        var params = new URLSearchParams(window.location.search);
        var email = params.get('email') || '';

        var emailDisplay = document.getElementById('emailDisplay');
        emailDisplay.textContent = email || '(no email provided)';

        if (!email) {
            document.getElementById('unsubBtn').disabled = true;
            document.getElementById('unsubBtn').textContent = 'No email address provided';
        }

        function handleUnsubscribe() {
            var btn = document.getElementById('unsubBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>&nbsp; Processing...';

            fetch(GAS_URL + '?action=unsubscribe_service&email=' + encodeURIComponent(email))
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    if (data.status === 'success' || data.status === 'ok') {
                        document.getElementById('successMsg').style.display = 'block';
                        btn.style.display = 'none';
                    } else {
                        throw new Error(data.message || 'Unknown error');
                    }
                })
                .catch(function(err) {
                    document.getElementById('errorMsg').style.display = 'block';
                    btn.innerHTML = '<i class="fas fa-redo"></i>&nbsp; Try Again';
                    btn.disabled = false;
                    btn.onclick = handleUnsubscribe;
                });
        }
    </script>
</body>
</html>
